// =====================================================
// SISTEMA GPS MECANIZADA - VERSÃO CORRIGIDA 2.0
// Correção do mapeamento de campos e melhorias de cache
// =====================================================

// CONFIGURAÇÕES
const CONFIG_CORPORATIVO = {
  empresaNome: "GPS MECANIZADA",
  departamento: "CONTROLE DE FROTA"
};

// =====================================================
// FUNÇÃO PRINCIPAL - PROCESSA AUTOMATICAMENTE
// =====================================================
function onFormSubmit(e) {
  try {
    console.log('=== NOVA RESPOSTA RECEBIDA ===');
    console.log('Timestamp:', new Date().toISOString());
    
    let responses = null;
    let sheet = null;
    
    // Obtém dados da resposta
    if (e && e.values && e.values.length > 0) {
      console.log('Dados recebidos do evento:', e.values);
      responses = e.values;
      
      // Tenta obter a planilha
      const form = FormApp.getActiveForm();
      if (form) {
        const spreadsheetId = form.getDestinationId();
        if (spreadsheetId) {
          const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
          sheet = spreadsheet.getSheets()[0];
        }
      }
    } else {
      console.log('Sem dados no evento, buscando última resposta da planilha...');
      
      // Fallback: pega última resposta da planilha
      const form = FormApp.getActiveForm();
      if (form) {
        const spreadsheetId = form.getDestinationId();
        if (spreadsheetId) {
          const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
          sheet = spreadsheet.getSheets()[0];
          const lastRow = sheet.getLastRow();
          
          if (lastRow > 1) {
            responses = sheet.getRange(lastRow, 1, 1, sheet.getLastColumn()).getValues()[0];
            console.log('Última resposta obtida da planilha:', responses);
          }
        }
      }
    }
    
    if (!responses || responses.length === 0) {
      console.log('Nenhuma resposta encontrada');
      return;
    }

    if (!sheet) {
      console.log('Não foi possível acessar a planilha');
      return;
    }
    
    // Obtém headers
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    console.log('Headers encontrados:', headers);
    
    // Processa dados com o novo método corrigido
    const dadosRegistro = extrairDadosCorrigidos(responses, headers);
    console.log('Dados extraídos:', dadosRegistro);
    
    // Gera texto formatado
    const textoFormatado = gerarTextoCorportativoCorrigido(dadosRegistro);
    console.log('Texto formatado gerado');
    
    // Cria ID único para esta resposta
    const respostaId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Salva resposta individual
    PropertiesService.getScriptProperties().setProperty(`resposta_${respostaId}`, JSON.stringify({
      dados: dadosRegistro,
      texto: textoFormatado,
      criado: new Date().toISOString()
    }));
    
    // Atualiza também a "última resposta"
    PropertiesService.getScriptProperties().setProperty('ultimaResposta', JSON.stringify({
      dados: dadosRegistro,
      texto: textoFormatado,
      processado: new Date().toISOString()
    }));
    
    console.log('=== RESPOSTA PROCESSADA COM SUCESSO ===');
    console.log('ID da resposta:', respostaId);
    
    // Limpa respostas antigas (mantém apenas as últimas 10)
    limparRespostasAntigas();
    
  } catch (error) {
    console.error('Erro no processamento:', error.toString());
    console.error('Stack:', error.stack);
  }
}

// =====================================================
// FUNÇÃO doGet - OTIMIZADA PARA CHROME
// =====================================================
function doGet(e) {
  try {
    const callback = e.parameter.callback;
    const respostaId = e.parameter.id;
    const forceRefresh = e.parameter.refresh === 'true';
    
    console.log('Requisição recebida:', {
      callback: callback,
      id: respostaId,
      refresh: forceRefresh,
      timestamp: new Date().toISOString()
    });
    
    let dados, texto;
    
    // Se tem ID específico, busca resposta específica
    if (respostaId) {
      const respostaEspecifica = PropertiesService.getScriptProperties().getProperty(`resposta_${respostaId}`);
      
      if (respostaEspecifica) {
        const parsed = JSON.parse(respostaEspecifica);
        dados = parsed.dados;
        texto = parsed.texto;
        console.log('Resposta específica encontrada:', respostaId);
      }
    }
    
    // Se não encontrou ou não tem ID, busca última resposta
    if (!dados) {
      const dadosSalvos = PropertiesService.getScriptProperties().getProperty('ultimaResposta');
      
      if (dadosSalvos) {
        const parsed = JSON.parse(dadosSalvos);
        dados = parsed.dados;
        texto = parsed.texto;
        console.log('Última resposta recuperada');
      } else {
        console.log('Nenhum dado salvo encontrado, tentando buscar da planilha...');
        
        // Tenta buscar diretamente da planilha
        const dadosPlanilha = buscarUltimaRespostaDaPlanilha();
        if (dadosPlanilha) {
          dados = dadosPlanilha.dados;
          texto = dadosPlanilha.texto;
          console.log('Dados obtidos da planilha');
        }
      }
    }
    
    // Prepara resposta JSON
    const resposta = {
      sucesso: !!dados && !!texto,
      dados: dados || {},
      texto: texto || '',
      timestamp: new Date().toISOString(),
      cacheBreaker: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      version: '2.0'
    };
    
    console.log('Enviando resposta:', {
      sucesso: resposta.sucesso,
      temDados: !!dados,
      temTexto: !!texto
    });
    
    // Para JSONP
    if (callback) {
      const jsonp = `${callback}(${JSON.stringify(resposta)})`;
      return ContentService.createTextOutput(jsonp)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    // Para requisições JSON normais
    return ContentService.createTextOutput(JSON.stringify(resposta))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Erro no doGet:', error.toString());
    console.error('Stack:', error.stack);
    
    const errorResponse = {
      sucesso: false,
      erro: 'Erro interno do servidor',
      detalhes: error.toString(),
      timestamp: new Date().toISOString(),
      cacheBreaker: Date.now(),
      version: '2.0'
    };
    
    if (e.parameter.callback) {
      const jsonp = `${e.parameter.callback}(${JSON.stringify(errorResponse)})`;
      return ContentService.createTextOutput(jsonp)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService.createTextOutput(JSON.stringify(errorResponse))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// =====================================================
// EXTRAÇÃO DE DADOS CORRIGIDA - MAPEAMENTO CORRETO
// =====================================================
function extrairDadosCorrigidos(responses, headers) {
  const dados = {
    timestamp: responses[0] || new Date(),
    tipoChecklist: '',
    operacao: '',
    placa: '',
    veiculo: '',
    responsavel: '',
    dataHora: '',
    km: '',
    observacoes: '',
    evidencias: ''
  };
  
  console.log('=== INICIANDO EXTRAÇÃO DE DADOS ===');
  console.log('Total de campos:', headers.length);
  
  // Mapeamento inteligente baseado em padrões comuns
  for (let i = 0; i < headers.length; i++) {
    const header = headers[i] || '';
    const valor = responses[i] || '';
    const headerLower = header.toLowerCase();
    
    if (valor && valor.toString().trim() !== '') {
      const valorString = valor.toString().trim();
      
      console.log(`Campo ${i}: "${header}" = "${valorString}"`);
      
      // 1. TIPO DE CHECKLIST
      if (headerLower.includes('tipo') && 
          (headerLower.includes('checklist') || headerLower.includes('check'))) {
        dados.tipoChecklist = valorString;
        console.log('→ Tipo de Checklist identificado');
      }
      
      // 2. OPERAÇÃO (Retirada/Devolução)
      else if (headerLower.includes('retirada') || 
               headerLower.includes('devolução') || 
               headerLower.includes('devolucao') ||
               headerLower.includes('operação') ||
               headerLower.includes('operacao')) {
        
        // Se o campo pergunta sobre retirada/devolução
        if ((headerLower.includes('retirada') && headerLower.includes('devolução')) ||
            (headerLower.includes('retirada') && headerLower.includes('devolucao'))) {
          dados.operacao = valorString;
          console.log('→ Operação identificada');
        }
      }
      
      // 3. PLACA E VEÍCULO
      else if (headerLower.includes('placa') || 
               headerLower.includes('veículo') || 
               headerLower.includes('veiculo')) {
        
        // Extrai placa usando regex
        const placaRegex = /([A-Z]{3}[-]?\d{4})/i;
        const matchPlaca = valorString.match(placaRegex);
        
        if (matchPlaca) {
          dados.placa = matchPlaca[0].toUpperCase().replace(/[^A-Z0-9]/g, '');
          console.log('→ Placa extraída:', dados.placa);
          
          // Extrai modelo do veículo (o que vem depois da placa)
          const textoAposPlaca = valorString.substring(valorString.indexOf(matchPlaca[0]) + matchPlaca[0].length);
          const modelo = textoAposPlaca.replace(/^[\s-]+/, '').trim();
          
          if (modelo && modelo.length > 1) {
            dados.veiculo = modelo;
            console.log('→ Veículo extraído:', dados.veiculo);
          }
        }
        // Se não tem placa mas tem texto, pode ser só o modelo
        else if (!dados.veiculo && valorString.length > 2) {
          dados.veiculo = valorString;
          console.log('→ Veículo (sem placa) identificado');
        }
      }
      
      // 4. RESPONSÁVEL
      else if (headerLower.includes('responsável') || 
               headerLower.includes('responsavel') ||
               headerLower.includes('nome') ||
               headerLower.includes('motorista')) {
        dados.responsavel = valorString;
        console.log('→ Responsável identificado');
      }
      
      // 5. DATA E HORA
      else if (headerLower.includes('data') || headerLower.includes('hora')) {
        // Verifica se é uma data válida
        if (valorString.includes('/') || valorString.includes('-') || 
            valorString.includes(':') || !isNaN(Date.parse(valorString))) {
          dados.dataHora = valorString;
          console.log('→ Data/Hora identificada');
        }
      }
      
      // 6. KM/QUILOMETRAGEM
      else if (headerLower.includes('km') || 
               headerLower.includes('quilometragem') || 
               headerLower.includes('odômetro') ||
               headerLower.includes('odometro')) {
        // Remove caracteres não numéricos
        const kmNumerico = valorString.replace(/[^0-9]/g, '');
        if (kmNumerico) {
          dados.km = kmNumerico;
          console.log('→ KM identificado');
        }
      }
      
      // 7. OBSERVAÇÕES
      else if (headerLower.includes('observação') || 
               headerLower.includes('observacao') ||
               headerLower.includes('observações') ||
               headerLower.includes('observacoes') ||
               headerLower.includes('comentário') ||
               headerLower.includes('comentario')) {
        dados.observacoes = valorString;
        console.log('→ Observações identificadas');
      }
      
      // 8. EVIDÊNCIAS
      else if (headerLower.includes('evidência') || 
               headerLower.includes('evidencia') ||
               headerLower.includes('foto') ||
               headerLower.includes('imagem') ||
               headerLower.includes('anexo')) {
        dados.evidencias = valorString;
        console.log('→ Evidências identificadas');
      }
    }
  }
  
  // Validações e correções finais
  
  // Se não identificou operação pelo campo específico, tenta inferir
  if (!dados.operacao && dados.tipoChecklist) {
    if (dados.tipoChecklist.toLowerCase().includes('retirada')) {
      dados.operacao = 'Retirada';
    } else if (dados.tipoChecklist.toLowerCase().includes('devolução') || 
               dados.tipoChecklist.toLowerCase().includes('devolucao')) {
      dados.operacao = 'Devolução';
    }
  }
  
  // Formata a placa corretamente (XXX-9999)
  if (dados.placa && dados.placa.length === 7 && !dados.placa.includes('-')) {
    dados.placa = dados.placa.substring(0, 3) + '-' + dados.placa.substring(3);
  }
  
  console.log('=== DADOS EXTRAÍDOS FINAL ===');
  console.log(dados);
  
  return dados;
}

// =====================================================
// GERAR TEXTO CORPORATIVO CORRIGIDO
// =====================================================
function gerarTextoCorportativoCorrigido(dados) {
  let texto = `GPS MECANIZADA - CONTROLE DE FROTA\n`;
  
  // Determina o tipo de registro baseado na operação
  if (dados.operacao === 'Retirada' || 
      (dados.tipoChecklist && dados.tipoChecklist.toLowerCase().includes('retirada'))) {
    texto += `CHECKLIST - RETIRADA\n`;
  } else if (dados.operacao === 'Devolução' || 
             dados.operacao === 'Devolucao' ||
             (dados.tipoChecklist && (dados.tipoChecklist.toLowerCase().includes('devolução') || 
                                       dados.tipoChecklist.toLowerCase().includes('devolucao')))) {
    texto += `CHECKLIST - DEVOLUÇÃO\n`;
  } else {
    texto += `REGISTRO DE USO\n`;
  }
  
  texto += `================================\n\n`;
  
  // Adiciona tipo se for diferente da operação principal
  if (dados.tipoChecklist && 
      !dados.tipoChecklist.toLowerCase().includes('retirada') && 
      !dados.tipoChecklist.toLowerCase().includes('devolução') &&
      !dados.tipoChecklist.toLowerCase().includes('devolucao')) {
    texto += `TIPO: ${dados.tipoChecklist}\n`;
  }
  
  // Placa
  if (dados.placa) {
    texto += `PLACA: ${dados.placa}\n`;
  } else {
    texto += `PLACA: N/I\n`;
  }
  
  // Veículo
  if (dados.veiculo) {
    texto += `VEÍCULO: ${dados.veiculo}\n`;
  }
  
  // Responsável
  if (dados.responsavel) {
    texto += `RESPONSÁVEL: ${dados.responsavel}\n`;
  } else {
    texto += `RESPONSÁVEL: N/I\n`;
  }
  
  // Data/Hora
  if (dados.dataHora) {
    const dataFormatada = formatarDataHoraBR(dados.dataHora);
    texto += `DATA/HORA: ${dataFormatada}\n`;
  }
  
  // KM
  if (dados.km) {
    texto += `KM: ${dados.km}\n`;
  }
  
  // Observações
  if (dados.observacoes && dados.observacoes.trim().length > 0) {
    texto += `\nOBSERVAÇÕES:\n${dados.observacoes}\n`;
  }
  
  // Evidências
  if (dados.evidencias && dados.evidencias.trim().length > 0) {
    texto += `\nEVIDÊNCIAS: Anexadas\n`;
  }
  
  texto += `\n================================\n`;
  texto += `REGISTRADO: ${formatarDataHoraBR(dados.timestamp)}\n`;
  texto += `GrupoGPS Mecanizada`;
  
  return texto;
}

// =====================================================
// FUNÇÕES AUXILIARES
// =====================================================

function formatarDataHoraBR(dataInput) {
  try {
    let date;
    
    // Se já é uma data
    if (dataInput instanceof Date) {
      date = dataInput;
    }
    // Se é string
    else if (typeof dataInput === 'string') {
      // Remove timezone info se houver
      const dataLimpa = dataInput.replace(/\s*\(.*?\)\s*/, '').trim();
      date = new Date(dataLimpa);
    }
    // Tenta converter
    else {
      date = new Date(dataInput);
    }
    
    // Se a data é válida
    if (!isNaN(date.getTime())) {
      const dia = String(date.getDate()).padStart(2, '0');
      const mes = String(date.getMonth() + 1).padStart(2, '0');
      const ano = date.getFullYear();
      const hora = String(date.getHours()).padStart(2, '0');
      const minuto = String(date.getMinutes()).padStart(2, '0');
      
      return `${dia}/${mes}/${ano}, ${hora}:${minuto}`;
    }
    
    // Se não conseguiu converter, retorna como está
    return dataInput.toString();
    
  } catch (e) {
    console.error('Erro ao formatar data:', e);
    return dataInput.toString();
  }
}

// Busca última resposta diretamente da planilha
function buscarUltimaRespostaDaPlanilha() {
  try {
    const form = FormApp.getActiveForm();
    if (!form) return null;
    
    const spreadsheetId = form.getDestinationId();
    if (!spreadsheetId) return null;
    
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    const sheet = spreadsheet.getSheets()[0];
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) return null;
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const responses = sheet.getRange(lastRow, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    const dados = extrairDadosCorrigidos(responses, headers);
    const texto = gerarTextoCorportativoCorrigido(dados);
    
    return { dados, texto };
    
  } catch (error) {
    console.error('Erro ao buscar da planilha:', error);
    return null;
  }
}

// Limpa respostas antigas (mantém apenas as últimas 10)
function limparRespostasAntigas() {
  try {
    const props = PropertiesService.getScriptProperties();
    const keys = props.getKeys();
    
    // Filtra apenas as chaves de respostas individuais
    const respostaKeys = keys.filter(k => k.startsWith('resposta_')).sort();
    
    // Se tem mais de 10, remove as mais antigas
    if (respostaKeys.length > 10) {
      const keysParaRemover = respostaKeys.slice(0, respostaKeys.length - 10);
      keysParaRemover.forEach(key => {
        props.deleteProperty(key);
        console.log('Resposta antiga removida:', key);
      });
    }
  } catch (error) {
    console.error('Erro ao limpar respostas antigas:', error);
  }
}

// =====================================================
// FUNÇÃO DE TESTE MANUAL
// =====================================================
function testarProcessamento() {
  // Simula o último registro real baseado na planilha fornecida
  const respostaTeste = {
    values: [
      new Date('2025-09-04 15:51:21'), // Timestamp
      '', // Campo vazio
      'Registro de Uso', // Tipo
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      'Genésio Adão Miranda', // Responsável
      'Devolução', // Operação  
      'TEX-4C06 - SAVEIRO', // Placa e Veículo
      '04/09/2025 15:51:00', // Data/Hora
      'Sem anormalidade' // Observações
    ]
  };
  
  // Headers baseados na planilha
  const headers = [
    'Carimbo de data/hora', '', 'Tipo de Checklist',
    // Muitos campos vazios...
    '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
    'Responsável pela Operação',
    'Retirada ou Devolução do Veículo',  
    'Placa do Veículo',
    'Data e Hora da Operação',
    'Observações'
  ];
  
  const dados = extrairDadosCorrigidos(respostaTeste.values, headers);
  const texto = gerarTextoCorportativoCorrigido(dados);
  
  console.log('=== TESTE DE PROCESSAMENTO ===');
  console.log('Dados extraídos:', dados);
  console.log('Texto gerado:\n', texto);
  
  // Salva como última resposta para teste
  PropertiesService.getScriptProperties().setProperty('ultimaResposta', JSON.stringify({
    dados: dados,
    texto: texto,
    processado: new Date().toISOString(),
    teste: true
  }));
  
  console.log('✅ Teste salvo como última resposta');
  
  return { dados, texto };
}
